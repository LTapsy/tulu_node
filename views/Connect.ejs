@{
    ViewBag.Title = "Home Page";
}

<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>@ViewBag.Title - My ASP.NET Application</title>
    <link rel="stylesheet" href="styles/reset.css" />
    <link rel="stylesheet" href="Webfonts/styles/all.css" />
    <link rel="stylesheet" href="styles/nav.css" />
    <link rel="stylesheet" href="styles/connect.css" />
    <link rel="preconnect" href="https://fonts.gstatic.com">
    <link href="https://fonts.googleapis.com/css2?family=Open+Sans&display=swap" rel="stylesheet">
    <script type="text/javascript" src="jquery/dist/jquery.min.js"></script>
</head>
<body>
    <nav id="Nav">
        <a href="/">
            <img src="images/tulu-logo_white.png" alt="">
        </a>
        <div class="menuButton" onclick="slideMenu()">
            <i class="fas fa-bars fa-2x menuBtn"></i>
            <i class="fas fa-times fa-2x closeMenuBtn"></i>
        </div>
    </nav>

    <div id="SideMenu" class="sideMenu">
        <ul class="menu">
        </ul>
        <p class="loggedInAs"></p>
    </div>

    <div class="container body-content messages" style="margin:50px 0 0 0;">
        <h2>Messages</h2>
        

        <div class="newMessageContainer">
            <div class="wrapper">
            <div id="DealerList" style="visibility: hidden"></div>
            <div id="DealerVehicles" style="visibility: hidden"></div>
            <div id="DealerUsers" style="visibility: hidden"></div>
            <div id="TuluList" style="visibility: hidden"></div>
                <input type="hidden" id="ThreadValueId" value="" />
                <label>Subject:</label>
                <input type="text" id="SubjectText" value="" disabled/>
                <label>Body:</label>
                <!-- <input type="text" id="BodyText" value="" /> -->
                <textarea id="BodyText" value="" rows="5"></textarea>
                <label style="display:none;">Is Read:</label>
                <select style="display:none;" id="IsReadSelect" disabled>
                    <option value="0">False</option>
                    <option value="1">True</option>
                </select>
                <button onclick="NewMessage();">Send Message</button>
            </div>
        </div>
    </div>

</body>
<script src="Js/sideMenu.js"></script>
<script type="text/javascript" src="Js/Helpers/MessagesHelper.js"></script>
<script src="Js/privileges.js"></script>
<script>
var dealerId = "";
var vin = "";
var tuluId = "";
var gUserId = "";
var gMessage = null;

    window.onload = function () {
        var hash;
        var hashes = window.location.href.slice(window.location.href.indexOf("?") + 1).split("&");
        
        for (var i = 0; i < hashes.length; i++) {
            hash = hashes[i].split("=");
            if (hash[0] == "dealerId") {
                dealerId = hash[1];
            } else if (hash[0] == "vin") {
                vin = hash[1];
            } else if (hash[0] == "tuluId") {
                tuluId = hash[1];
                GetCurrentUser();
                GetPageVehicle(vin,dealerId);
            }
        }
        
        console.log(tuluId);
        
    }

    function populateMessageInput(){

    }

    function GetCurrentUser() {
        //FIXME: I think this needs to be deleted
        $.ajax({
            type: "PUT",
            url: "/Users/Current",
            cache: false,
            dataType: "json",
            contentType: "application/x-www-form-urlencoded",
            success: function (results) {
                gUserId = results.id;
                showNewMessage();
                populateMessageInput();
            },
            error: function (results) {
                alert("Error");
            },
        });
    }

    function NewMessage() {
        var obj = new Object();
        obj.senderId = gUserId;
        obj.targetId = tuluId;
        obj.dealerId = dealerId;
        obj.vin = vin;
        obj.threadId = '';
        $.ajax({
            type: "PUT",
            url: "/Messages/New",
            data: obj,
            cache: false,
            dataType: "json",
            contentType: "application/x-www-form-urlencoded",
            success: function (results) {
                gMessage = results;
                SaveMessage(gMessage);
                console.log(results);
                console.log(results);
            },
            error: function (results) {
                alert("Error");
            },
        });
    }

    function SaveMessage(gMessage) {
        var obj = new Object();
        obj = gMessage;
        obj.isRead = false;
        obj.subject = $("#SubjectText").val();
        obj.message = document.querySelector('#BodyText').value;
        obj.senderId = gMessage.senderId;
        obj.targetId = gMessage.targetId;
        obj.threadId = gMessage.threadId;
        obj.id = gMessage.id;
        obj.vin = gMessage.vin;
        $.ajax({
            type: "PUT",
            url: "/Messages/Save",
            data: obj,
            cache: false,
            dataType: "json",
            contentType: "application/x-www-form-urlencoded",
            success: function (results) {
                // location.href = '/home/messages';
                console.log(results);
                window.location = "/Home/CarView?vin=" + vin + "&dealerId=" + dealerId;
            },
            error: function (results) {
                alert("Error");
            },
        });
    }

    function GetPageVehicle(vin, dealerId) {
        GetVehicle(vin, dealerId).then(function (vehicle) {
            console.log(vehicle);
            $('#SubjectText').val(vehicle.year+" "+vehicle.make+" "+vehicle.model);
        });
    }

    async function GetVehicle(vin, dealerId) {
        var obj = new Object();
        obj.vin = vin;
        obj.dealerId = dealerId;
        const results = await $.ajax({
            type: "PUT",
            url: "/Vehicle/Get",
            data: obj,
            cache: false,
            dataType: "json",
            contentType: "application/x-www-form-urlencoded",
            success: function (results) { },
            error: function (results) { console.log(results.statusText); },
        });
        return results;
    }



</script>


@if (User.Identity.IsAuthenticated)
{
    <Script>
        GetUser();
    </Script>

}
else
{
    <Script>
        guestprivileges();
    </Script>

}
</html>